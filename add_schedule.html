<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Agendamento de Eventos</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
</head>
<body class="container my-5">

  <h2 class="mb-4">Cadastrar Agendamento</h2>

  <form id="scheduleForm" class="row g-3">
    <div class="col-md-2">
      <label for="date" class="form-label">Data</label>
      <input type="date" class="form-control" id="date" required>
    </div>

    <div class="col-md-2">
      <label for="time" class="form-label">Hora</label>
      <input type="time" class="form-control" id="time" required>
    </div>

    <div class="col-md-2">
      <label for="myevent" class="form-label">Evento</label>
      <select id="myevent" class="form-select" required></select>
    </div>

    <div class="col-md-2">
      <label for="typeevent" class="form-label">Tipo</label>
      <select id="typeevent" class="form-select" required></select>
    </div>

    <div class="col-md-2">
      <label for="vacancies" class="form-label">Vagas</label>
      <input type="number" class="form-control" id="vacancies" min="1" required>
    </div>

    <div class="col-12">
      <button type="submit" class="btn btn-primary">Agendar</button>
    </div>
  </form>

  <hr class="my-5">

  <h3>Agendamentos Realizados</h3>

  <div class="table-responsive">
    <table class="table table-bordered table-striped mt-3" id="scheduleTable">
      <thead class="table-dark">
        <tr>
          <th>Data</th>
          <th>Hora</th>
          <th>Evento</th>
          <th>Tipo</th>
          <th>Preço</th>
          <th>Vagas</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const myeventSelect = document.getElementById('myevent');
    const typeeventSelect = document.getElementById('typeevent');

    // Carrega opções de Evento
    fetch('http://localhost:8000/api/generic/list.php?table=myevent')
      .then(res => res.json())
      .then(events => {
        events.forEach(ev => {
          const option = document.createElement('option');
          option.value = ev.id_myevent;
          option.textContent = ev.myevent;
          option.setAttribute('data-price', ev.price);
          myeventSelect.appendChild(option);
        });
      });

    // Carrega opções de Tipo de Evento
    fetch('http://localhost:8000/api/generic/list.php?table=typeevent')
      .then(res => res.json())
      .then(types => {
        types.forEach(tp => {
          const option = document.createElement('option');
          option.value = tp.id_tpEvent;
          option.textContent = tp.tpEvent;
          typeeventSelect.appendChild(option);
        });
      });

    // Enviar o formulário
    document.getElementById('scheduleForm').addEventListener('submit', function (e) {
      e.preventDefault();

      const data = {
        table: "schedule",
        values: {
          date: document.getElementById('date').value,
          time: document.getElementById('time').value,
          id_myevent: myeventSelect.value,
          id_tpEvent: typeeventSelect.value,
          vacancies: parseInt(document.getElementById('vacancies').value)
        }
      };

      fetch('http://localhost:8000/api/generic/create.php', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(data)
      })
        .then(res => res.json())
        .then(response => {
          alert('Agendamento criado com sucesso!');
          document.getElementById('scheduleForm').reset();
          carregarAgendamentos();
        })
        .catch(err => {
          console.error(err);
          alert('Erro ao agendar.');
        });
    });

    // Listar todos os agendamentos na tabela
    function carregarAgendamentos() {
      fetch('http://localhost:8000/api/generic/list.php?table=schedule')
        .then(res => res.json())
        .then(agendamentos => {
          const tbody = document.querySelector('#scheduleTable tbody');
          tbody.innerHTML = '';

          agendamentos.forEach(item => {
            const evOpt = myeventSelect.querySelector(`option[value="${item.id_myevent}"]`);
            const tpOpt = typeeventSelect.querySelector(`option[value="${item.id_tpEvent}"]`);

            const dataFormatada = new Date(item.date).toLocaleDateString('pt-BR');
            const eventName = evOpt?.textContent || '—';
            const typeName = tpOpt?.textContent || '—';
            const price = evOpt?.getAttribute('data-price') || '—';

            const row = `
              <tr>
                <td>${dataFormatada}</td>
                <td>${item.time}</td>
                <td>${eventName}</td>
                <td>${typeName}</td>
                <td>R$ ${price}</td>
                <td>${item.vacancies}</td>
              </tr>
            `;
            tbody.insertAdjacentHTML('beforeend', row);
          });
        });
    }

    // Ao carregar a página
    window.onload = () => {
      carregarAgendamentos();
    };
  </script>

</body>
</html>
